#include "DES.h"

UBYTE v[16] = { 1, 1, 2, 2, 2, 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 1 };
UBYTE out[8];

void pc1(UBYTE k[7])
{
	out[0] |= ((k[7] >> 7) & 1) << 7;
	out[0] |= ((k[6] >> 7) & 1) << 6;
	out[0] |= ((k[5] >> 7) & 1) << 5;
	out[0] |= ((k[4] >> 7) & 1) << 4;
	out[0] |= ((k[3] >> 7) & 1) << 3;
	out[0] |= ((k[2] >> 7) & 1) << 2;
	out[0] |= ((k[1] >> 7) & 1) << 1;
	out[0] |= ((k[0] >> 7) & 1);

	out[1] |= ((k[7] >> 6) & 1) << 7;
	out[1] |= ((k[6] >> 6) & 1) << 6;
	out[1] |= ((k[5] >> 6) & 1) << 5;
	out[1] |= ((k[4] >> 6) & 1) << 4;
	out[1] |= ((k[3] >> 6) & 1) << 3;
	out[1] |= ((k[2] >> 6) & 1) << 2;
	out[1] |= ((k[1] >> 6) & 1) << 1;
	out[1] |= ((k[0] >> 6) & 1);

	out[2] |= ((k[7] >> 5) & 1) << 7;
	out[2] |= ((k[6] >> 5) & 1) << 6;
	out[2] |= ((k[5] >> 5) & 1) << 5;
	out[2] |= ((k[4] >> 5) & 1) << 4;
	out[2] |= ((k[3] >> 5) & 1) << 3;
	out[2] |= ((k[2] >> 5) & 1) << 2;
	out[2] |= ((k[1] >> 5) & 1) << 1;
	out[2] |= ((k[0] >> 5) & 1);

	out[3] |= ((k[7] >> 4) & 1) << 7;
	out[3] |= ((k[6] >> 4) & 1) << 6;
	out[3] |= ((k[5] >> 4) & 1) << 5;
	out[3] |= ((k[4] >> 4) & 1) << 4;

	out[4] |= ((k[7] >> 1) & 1) << 7;
	out[4] |= ((k[6] >> 1) & 1) << 6;
	out[4] |= ((k[5] >> 1) & 1) << 5;
	out[4] |= ((k[4] >> 1) & 1) << 4;
	out[4] |= ((k[3] >> 1) & 1) << 3;
	out[4] |= ((k[2] >> 1) & 1) << 2;
	out[4] |= ((k[1] >> 1) & 1) << 1;
	out[4] |= ((k[0] >> 1) & 1);

	out[5] |= ((k[7] >> 2) & 1) << 7;
	out[5] |= ((k[6] >> 2) & 1) << 6;
	out[5] |= ((k[5] >> 2) & 1) << 5;
	out[5] |= ((k[4] >> 2) & 1) << 4;
	out[5] |= ((k[3] >> 2) & 1) << 3;
	out[5] |= ((k[2] >> 2) & 1) << 2;
	out[5] |= ((k[1] >> 2) & 1) << 1;
	out[5] |= ((k[0] >> 2) & 1);

	out[6] |= ((k[7] >> 3) & 1) << 7;
	out[6] |= ((k[6] >> 3) & 1) << 6;
	out[6] |= ((k[5] >> 3) & 1) << 5;
	out[6] |= ((k[4] >> 3) & 1) << 4;
	out[6] |= ((k[3] >> 3) & 1) << 3;
	out[6] |= ((k[2] >> 3) & 1) << 2;
	out[6] |= ((k[1] >> 3) & 1) << 1;
	out[6] |= ((k[0] >> 3) & 1);

	out[7] |= ((k[3] >> 4) & 1) << 7;
	out[7] |= ((k[2] >> 4) & 1) << 6;
	out[7] |= ((k[1] >> 4) & 1) << 5;
	out[7] |= ((k[0] >> 4) & 1) << 4;
}

void key_gen(UBYTE k[7], UBYTE sk[16][6])
{
	UBYTE L[4], R[4], temp1[4], temp2[4];
	int i, j;

	pc1(k);

	for (i = 0; i < 4; i++)
	{
		L[i] = out[i];
		R[i] = out[4 + i];
	}

	for (i = 0; i < 16; i++)
	{
		for (j = 0; j < 4; j++)
		{
			temp1[j] = L[j];
			temp2[j] = R[j];
		}

		for (j = 0; j < 4; j++)
		{
			L[j] |= L[j] << v[i];
			R[j] |= R[j] << v[i];
		}
			
		for (j = 0; j < 3; j++)
		{
			L[j] |= (temp1[1 + j] >> 7) & 1;
			R[j] |= (temp2[1 + j] >> 7) & 1;
		}

		L[3] |= ((temp1[0] >> 7) & 1) << 3;
		R[3] |= ((temp2[0] >> 7) & 1) << 3;


		sk[i][0] |= ((L[1] >> 2) & 1) << 7;
		sk[i][0] |= ((L[2] >> 7) & 1) << 6;
		sk[i][0] |= ((L[1] >> 5) & 1) << 5;
		sk[i][0] |= (L[2] & 1) << 4;
		sk[i][0] |= ((L[0] >> 7) & 1) << 3;
		sk[i][0] |= ((L[0] >> 3) & 1) << 2;
		sk[i][0] |= ((L[0] >> 5) & 1) << 1;
		sk[i][0] |= ((L[3] >> 4) & 1);

		sk[i][1] |= ((L[1] >> 1) & 1) << 7;
		sk[i][1] |= ((L[0] >> 2) & 1) << 6;
		sk[i][1] |= ((L[2] >> 3) & 1) << 5;
		sk[i][1] |= ((L[1] >> 6) & 1) << 4;
		sk[i][1] |= ((L[2] >> 1) & 1) << 3;
		sk[i][1] |= ((L[2] >> 5) & 1) << 2;
		sk[i][1] |= ((L[1] >> 4) & 1) << 1;
		sk[i][1] |= ((L[0] >> 4) & 1);

		sk[i][2] |= ((L[3] >> 6) & 1) << 7;
		sk[i][2] |= (L[0] & 1) << 6;
		sk[i][2] |= (L[1] & 1) << 5;
		sk[i][2] |= ((L[0] >> 1) & 1) << 4;
		sk[i][2] |= ((L[3] >> 5) & 1) << 3;
		sk[i][2] |= ((L[2] >> 4) & 1) << 2;
		sk[i][2] |= ((L[1] >> 3) & 1) << 1;
		sk[i][2] |= ((L[0] >> 6) & 1);

		sk[i][3] |= ((R[1] >> 3) & 1) << 7;
		sk[i][3] |= (R[2] & 1) << 6;
		sk[i][3] |= ((R[0] >> 5) & 1) << 5;
		sk[i][3] |= ((R[1] >> 7) & 1) << 4;
		sk[i][3] |= ((R[2] >> 5) & 1) << 3;
		sk[i][3] |= ((R[3] >> 5) & 1) << 2;
		sk[i][3] |= ((R[0] >> 6) & 1) << 1;
		sk[i][3] |= ((R[1] >> 4) & 1);

		sk[i][4] |= ((R[2] >> 1) & 1) << 7;
		sk[i][4] |= ((R[2] >> 7) & 1) << 6;
		sk[i][4] |= ((R[0] >> 3) & 1) << 5;
		sk[i][4] |= ((R[2] >> 4) & 1) << 4;
		sk[i][4] |= (R[1] & 1) << 3;
		sk[i][4] |= ((R[2] >> 3) & 1) << 2;
		sk[i][4] |= ((R[1] >> 5) & 1) << 1;
		sk[i][4] |= ((R[3] >> 4) & 1);

		sk[i][5] |= ((R[0] >> 2) & 1) << 7;
		sk[i][5] |= ((R[3] >> 7) & 1) << 6;
		sk[i][5] |= ((R[2] >> 6) & 1) << 5;
		sk[i][5] |= ((R[1] >> 2) & 1) << 4;
		sk[i][5] |= ((R[2] >> 2) & 1) << 3;
		sk[i][5] |= (R[0] & 1) << 2;
		sk[i][5] |= ((R[0] >> 7) & 1) << 1;
		sk[i][5] |= ((R[0] >> 4) & 1);
		}
	}

